<link rel="import" href="../bower_components/polymer/polymer.html">

<dom-module id="change-list">
  <style>
    :host {
      display: block;
    }
    table {
      border: 1px solid #eee;
      border-collapse: collapse;
      width: 100%;
    }
    th, td {
      border-bottom: 1px solid #eee;
      padding: 2px 5px;
      vertical-align: top;
    }
    th {
      background: #eee;
      text-align: left;
    }
    a {
      color: #000;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    .positionIndicator {
      visibility: hidden;
    }
    .is-selected .positionIndicator {
      visibility: visible;
    }
    .avatarImage {
      height: 16px;
      vertical-align: -4px;
      width: 16px;
    }
  </style>

  <template>
    <iron-ajax
        auto
        url="/changes/"
        params='{"n": 25, "O": 81}'
        handle-as="text"
        on-response="_handleResponse"
        debounce-duration="300"></iron-ajax>
    <iron-a11y-keys
        target="[[keyTarget]]"
        keys="j k"
        on-keys-pressed="_handleKey"></iron-a11y-keys>
    <div>{{query}}</div>
    <table tabindex="0">
      <tr>
        <th></th> <!-- keyboard position indicator -->
        <th>Subject</th>
        <th>Status</th>
        <th>Owner</th>
        <th>Project</th>
        <th>Branch</th>
        <th>Updated</th>
        <th>Size</th>
        <th title="Code-Review">CR</th>
        <th title="Library-Compliance">LC</th>
        <th title="Verified">V</th>
      </tr>
      <template is="dom-repeat" items="[[changes]]" as="change">
        <tr>
          <td>
            <span class="positionIndicator">&#x25b6;</span>
          </td>
          <td>
            <a href$="[[_changeURL(change)]]">[[change.subject]]</a>
          </td>
          <td>[[change.status]]</td>
          <td>
            <img class="avatarImage" src$="[[change.owner.avatars.0.url]]">
            <a href$="[[_ownerLink(change.owner)]]" title$="[[_ownerTitle(change.owner)]]">[[change.owner.name]]</a>
          </td>
          <td>
            <a href$="[[_projectURL(change.project)]]">[[change.project]]</a>
          </td>
          <td>
            <a href$="[[_projectBranchURL(change.project, change.branch)]]">[[change.branch]]</a>
          </td>
          <td>[[_updatedString(change.updated)]]</td>
          <td>Size</td>
          <td title="Code-Review">CR</td>
          <td title="Library-Compliance">LC</td>
          <td title="Verified">V</td>
        </tr>
      </template>
    </table>
  </template>
</dom-module>

<script>
  var BASE_URL = 'https://gerrit-review.googlesource.com/';

  Polymer({
    is: "change-list",

    properties: {
      /**
       * The query string used to refine the list.
       */
      query: {
        type: String,
        value: ''
      }
    },

    keyTarget: {
      type: Object,
      value: function() {
        return document.body;
      }
    },

    _handleResponse: function(e, req) {
      this.changes = JSON.parse(req.response.substring(')]}\''.length));
    },

    _handleKey: function(e) {
      switch(e.detail.combo) {
        case 'j':
          console.log('down')
          break;
        case 'k':
          console.log('up')
          break;
      }
    },

    _changeURL: function(change) {
      return BASE_URL + change._number;
    },

    _ownerLink: function(owner) {
      return BASE_URL + '#/q/owner:' + encodeURIComponent(owner.email) + '+status:open';
    },

    _ownerTitle: function(owner) {
      // TODO: Is this safe from XSS attacks?
      return owner.name + ' <' + owner.email + '>';
    },

    _projectURL: function(project) {
      return BASE_URL + '#/projects/' + project + ',dashboards/default';
    },

    _projectBranchURL: function(project, branch) {
      return BASE_URL + '#/q/status:open+project:' + project + '+branch:' + branch;
    },

    _updatedString: function(updated) {
      var d = new Date(updated);
      return d;
    }

  });
</script>
