<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="gr-date-formatter">
  <template>
    <style>
      :host {
        display: inline;
      }
    </style>
    <span>{{_computeDateStr(dateStr)}}</span>
  </template>
  <script>
  (function() {
    'use strict';

    var Duration = {
      HOUR: 1000 * 60 * 60,
      DAY: 1000 * 60 * 60 * 24,
    };

    var ShortMonthNames = [
      'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct',
      'Nov', 'Dec'
    ];

    Polymer({
      is: 'gr-date-formatter',

      properties: {
        dateStr: {
          type: String,
          value: null,
          notify: true
        }
      },

      _parseDateStr: function(dateStr) {
        // Timestamps are given in UTC and have the format
        // "'yyyy-mm-dd hh:mm:ss.fffffffff'" where "'ffffffffff'" represents
        // nanoseconds.

        // Munge the date into an ISO 8061 format and parse that.
        return new Date(dateStr.replace(' ', 'T') + 'Z');
      },

      _computeDateStr: function(dateStr, opt_from) {
        var d = this._parseDateStr(dateStr);
        var from = opt_from || new Date();
        var diff = from.getTime() - d.getTime();

        if (diff < Duration.DAY && d.getDay() == from.getDay()) {
          // Within 24 hours and on the same day:
          // '2:14 AM'
          var pm = d.getHours() >= 12;
          var hours = d.getHours() === 0 ? 12 :
              pm ? d.getHours() - 12 : d.getHours();
          var minutes = d.getMinutes() < 10 ? '0' + d.getMinutes() :
              d.getMinutes();
          return hours + ':' + minutes + (pm ? ' PM' : ' AM');
        } else if ((d.getDay() != from.getDay() || diff >= Duration.DAY) &&
                   diff < 180 * Duration.DAY) {
          // From one to six months:
          // 'Aug 29'
          return ShortMonthNames[d.getMonth()] + ' ' + d.getDate();
        } else if (diff >= 180 * Duration.DAY) {
          // More than six months:
          // 'Aug 29, 1997'
          return ShortMonthNames[d.getMonth()] + ' ' + d.getDate() + ', ' +
              d.getFullYear();
        }
      },
    });
  })();
  </script>
</dom-module>
