<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="gr-diff">
  <template>
    <style include="gr-diff-code-theme">
      :host {
        display: block;
      }
      table {
        border-collapse: collapse;
        font-family: 'Source Code Pro', monospace;
        white-space: pre-wrap;
        word-wrap: break-word;
      }
      td {
        vertical-align: top;
      }
      .lineNum {
        border-right: 1px solid #ddd;
        color: #aaa;
        cursor: pointer;
        padding-right: 10px;
        text-align: right;
      }
      .lineNum:hover {
        text-decoration: underline;
      }
      td:not(.lineNum) {
        padding-left: 5px;
      }
      .removedLine {
        background-color: #fee;
      }
      .addedLine {
        background-color: #efe;
      }
    </style>
    <iron-ajax
        auto
        url="/diff.json"
        handle-as="text"
        on-response="_handleResponse"
        debounce-duration="300"></iron-ajax>
    <table id="diffTable"></table>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'gr-diff',

      properties: {},

      _handleResponse: function(e, req) {
        var diff = JSON.parse(req.response.substring(')]}\''.length));
        this._constructDOM(diff);
      },

      _constructDOM: function(diff) {
        if (!diff.content) { return; }

        var lineNum = 0 + (diff.content.skip || 0);
        for (var i = 0; i < diff.content.length; i++) {
          var diffChunk = diff.content[i];
          if (diffChunk.ab) {
            for (var j = 0; j < diffChunk.ab.length; j++) {
              this._addRow(++lineNum, diffChunk.ab[j], diffChunk.ab[j], false);
            }
            continue;
          }
          if (diffChunk.a || diffChunk.b) {
            var maxLen = Math.max(diffChunk.a && diffChunk.a.length,
                diffChunk.b && diffChunk.b.length);
            for (var j = 0; j < maxLen; j++) {
              var leftContent;
              if (diffChunk.a && j < diffChunk.a.length) {
                leftContent = diffChunk.a[j];
              }
              var rightContent;
              if (diffChunk.b && j < diffChunk.b.length) {
                rightContent = diffChunk.b[j];
              }
              this._addRow(++lineNum, leftContent, rightContent, true);
            }
          }
        }
      },

      _addRow: function(lineNum, leftContent, rightContent, highlight) {
        var rowEl = document.createElement('tr');
        var leftLineNumEl = document.createElement('td');
        var rightLineNumEl = document.createElement('td');
        var leftColEl = document.createElement('td');
        leftColEl.className = 'style-scope gr-diff';
        var rightColEl = document.createElement('td');
        rightColEl.className = 'style-scope gr-diff';
        leftLineNumEl.className = 'style-scope gr-diff lineNum';
        rightLineNumEl.className = 'style-scope gr-diff lineNum';
        leftLineNumEl.textContent = lineNum;
        rightLineNumEl.textContent = lineNum;

        var leftHTML = this._highlightedHTML(leftContent);
        var rightHTML;
        if (leftContent == rightContent) {
          rightHTML = leftHTML;
        } else {
          rightHTML = this._highlightedHTML(rightContent);
        }
        // If the html is just the text then it didn't get highlighted.
        // Use textContent which is faster than innerHTML.
        if (leftContent == leftHTML) {
          leftColEl.textContent = leftContent;
        } else {
          leftColEl.innerHTML = leftHTML;
        }
        if (rightContent == rightHTML) {
          rightColEl.textContent = rightContent;
        } else {
          rightColEl.innerHTML = rightHTML;
        }

        if (highlight) {
          leftColEl.classList.add('removedLine');
          rightColEl.classList.add('addedLine');
        }
        rowEl.appendChild(leftLineNumEl);
        rowEl.appendChild(leftColEl);
        rowEl.appendChild(rightLineNumEl);
        rowEl.appendChild(rightColEl);
        this.$.diffTable.appendChild(rowEl);
      },

      _highlightedHTML: function(html) {
        return html;
      },

    });
  })();
  </script>
</dom-module>
